@model IEnumerable<IMS.Models.TraceDetail>

@{
  string thisTraceNo = ViewBag.TraceNo;
  double avgWeight = 96.3;
  int pigCnt = 116;
  double sumWeight = avgWeight * pigCnt;
  IMS.DAL.IMSDBContext IMSdb = new IMS.DAL.IMSDBContext();
  DateTime bornDate = IMSdb.TraceDetail.Where(m => m.TraceNo == thisTraceNo && m.WorkType == "出生").Select(m => m.WorkDate).FirstOrDefault();
  bool isOut = IMSdb.TraceDetail.Where(m => m.TraceNo == thisTraceNo && m.WorkType == "生產出貨").Any();

}

@using (Ajax.BeginForm("_TraceDetails", new { traceNo = ViewBag.TraceNo }, new AjaxOptions { UpdateTargetId = "traceDetail-tool", HttpMethod = "Post", OnSuccess = "init();" }))
{
  <div id="traceDetail-tool">
    <div class="row">

      <div class="col-md-8">
        @Html.Action("_CreateTraceDetail", new { traceNo = ViewBag.TraceNo })

      </div>
      <div class="col-md-4">
        <h3>詳細資料</h3>
        <h4>
          豬隻數量:
          <span>@pigCnt</span>
        </h4>

        @{
          if (isOut)
          {
            <h4>
              出貨日齡:
              @{
                DateTime outDate = IMSdb.TraceDetail.Where(m => m.TraceNo == thisTraceNo && m.WorkType == "生產出貨").Select(m => m.WorkDate).FirstOrDefault();
                var outdaysAge = (outDate - bornDate).TotalDays;

                <span>@outdaysAge 天</span>
              }

            </h4>
            <h4>
              出貨平均重量(kg):@avgWeight
            </h4>
            <h4>
              總重量(kg):@sumWeight

            </h4>
            
            }
          else
          {
            <h4>
              目前日齡:
              @{

                var daysAge = (DateTime.Today - bornDate).TotalDays;

                <span>@daysAge 天</span>

              }
            </h4>
            <h4>
              目前豬舍:
              <label class="radio-inline"><input type="radio" name="optradio" checked>分娩舍</label>
              <label class="radio-inline"><input type="radio" name="optradio">保育舍</label>
              <label class="radio-inline"><input type="radio" name="optradio">肉豬舍</label>
            </h4>
          }
        }

        <h4>
          總飼料量:
          @{

            double? feedSum = IMSdb.TraceDetail.Where(m => m.TraceNo == thisTraceNo && m.WorkType == "飼料").Sum(m => m.FeedValue);

            <span>@feedSum kg</span>

          }
        </h4>
        <h4>
          飼料換肉率:
          @{
            if(feedSum != null)
            {

              var feedToMeat = (sumWeight / feedSum);
              
              <span>@Convert.ToDouble(feedToMeat).ToString("0.00") kg</span>
            }

          }
        </h4>
      </div>
    </div>

    <h4>
      <b>
        作業紀錄
      </b>

      <div class="pull-right">
        <label class="checkbox-inline bg-warning myCheckBox"><input type="checkbox" value="" id="ckb-warning" checked>飼料</label>
        <label class="checkbox-inline bg-success myCheckBox"><input type="checkbox" value="" id="ckb-success" checked>投藥</label>
        <label class="checkbox-inline bg-danger myCheckBox"><input type="checkbox" value="" id="ckb-danger" checked>疫苗</label>
        <label class="checkbox-inline bg-info myCheckBox"><input type="checkbox" value="" id="ckb-info" checked>其他</label>
      </div>
    </h4>
    <hr class="underline-b" />

    <div class="row">
      @foreach (var item in Model)
      {
        string cssClass = "panel-info";
        if (item.WorkType == "飼料")
        {
          cssClass = "panel-warning";
        }
        else if (item.WorkType == "出生")
        {
          cssClass = "panel-default";
        }
        else if (item.WorkType == "投藥")
        {
          cssClass = "panel-success";
        }
        else if (item.WorkType == "疫苗")
        {
          cssClass = "panel-danger";
        }
        else if (item.WorkType == "生產出貨")
        {
          cssClass = "panel-primary";
        }

        @*7.3 在/Shared/_CommentsForPhoto.cshtml加入IEnumerable<T>及foreach (var item in Model){}*@
        <div class="col-md-4 col-sm-6">
          <div class="panel @cssClass">
            <div class="panel-heading clearfix">
              <div class="panel-title pull-left panel-tool">
                <p><b>@item.WorkType</b> </p>
                <sma class="pull-left">
                  @item.WorkDate.ToString("yyyy/MM/dd") @if (item.WorkDate_end.HasValue)
                {<span>-</span> @item.WorkDate_end.Value.ToString("yyyy/MM/dd")}
                </sma>
              </div>
              <div class="btn-group pull-right">
                <button type="button" class="btn-default btnEdit btn" id="btnEdit"  onclick="editMod(this)">
                  <li class="fa fa-pencil-square-o"></li>
                </button>
                <button type="button" class="btn-default btnSave btn" id="btnSave"  onclick="noteditMod(this)">
                  <li class="fa fa-floppy-o"></li>
                </button><a href="@Url.Action("DeleteTraceDetail", new { seqNo = item.SeqNo })" class="btn btn-default "  onclick="return confirm('確定要刪除嗎??')"><li class="fa fa-remove"></li></a>

                @*@Html.ActionLink(IMS.Resources.Resource.Comm_Delete, "DeleteTraceDetail", new { seqNo = item.SeqNo }, new { @class = "btn btn-default", onclick = "return confirm('您確定要刪除嗎??')" })*@

              </div>
            </div>
            <div class="panel-body" style="min-height:120px;">
              @Html.LabelFor(model => model.FirstOrDefault().WorkContent, htmlAttributes: new { @class = "control-label" })
              <span>:@item.WorkContent</span>

              @if (item.WorkMemo != null)
              {
                <br />
                @Html.LabelFor(model => model.FirstOrDefault().WorkMemo, htmlAttributes: new { @class = "control-label" })
                <span>:@item.WorkMemo</span>
              }

              @if (item.FeedValue != null)
              {
                <br />
                @Html.LabelFor(model => model.FirstOrDefault().FeedValue, htmlAttributes: new { @class = "control-label" })
                <span>:@item.FeedValue kg</span>
              }
            </div>

            @*//7-8-2 在_CommentsForPhoto.cshtml加入Delete連結*@
            @*<div class="panel-footer">
                  @Html.ActionLink(IMS.Resources.Resource.Comm_Delete, "Delete", new { id = item.SeqNo }, new { @class = "btn btn-warning", onclick = "return confirm('您確定要刪除嗎??')" })
              </div>*@
          </div>
        </div>
      }

    </div>
  </div>
}
